<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sarf Logic Engine</title>
    <style>
        :root {
            --primary: #007AFF;
            --success: #34C759;
            --bg: #F2F2F7;
            --card: #FFFFFF;
            --text: #000000;
            --danger: #FF3B30;
            --gray: #8E8E93;
            --weak: #FF9500; /* Orange for weakness */
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #e5e5e5;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .app-container {
            width: 100%;
            max-width: 400px;
            height: 100%;
            max-height: 700px;
            background-color: var(--bg);
            border: 1px solid #ccc;
            border-radius: 20px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
            position: relative;
        }
        .header {
            background: var(--card);
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid #ddd;
            font-weight: bold;
            font-size: 1.1em;
        }
        .content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        /* CARD & ROOT DISPLAY */
        .verb-card {
            background: var(--card);
            border-radius: 15px;
            padding: 25px 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        .result-word {
            font-size: 56px;
            font-weight: 800;
            margin: 10px 0;
            color: var(--text);
            transition: all 0.5s ease-out;
            min-height: 70px;
        }
        .root-meta {
            color: var(--primary);
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 1.2em;
        }
        .meaning-shift {
            color: var(--gray);
            font-style: italic;
            font-size: 0.9em;
        }

        /* FEATURE 1: PATTERN DIAL (Dropdown simulation for now) */
        .dial-controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr; 
            gap: 10px;
            margin-bottom: 20px;
        }
        .dial-controls-tense {
            grid-column: 1 / span 3;
        }
        select, input[type="text"] {
            padding: 8px; 
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 14px;
            background: white;
            box-sizing: border-box;
            /* Ensure text is visible in narrow spaces */
            min-width: 0; 
        }
        
        /* WEAK VERB LAB - Visual */
        .weak-letter {
            color: var(--weak);
            animation: shake-weak 0.7s infinite alternate;
        }
        @keyframes shake-weak {
            from { transform: rotate(0deg); }
            to { transform: rotate(2deg); }
        }
        .cracked {
            color: var(--danger);
            text-decoration: line-through;
            opacity: 0.5;
            transition: all 0.5s;
        }
        .hidden-letter {
            display: none;
        }
        .slide-in {
            transition: opacity 0.5s, transform 0.5s;
            opacity: 0;
            transform: translateY(-10px); 
        }
        .slide-in.active {
            opacity: 1;
            transform: translateY(0);
        }
        .form-info {
            background: #E5E5EA;
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 0.85em;
            text-align: left;
        }

        /* FEATURE 3: REVERSE LOOKUP */
        .reverse-input-section {
            padding: 15px;
            background: #fff;
            border-radius: 15px;
            margin-top: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .reverse-results {
            margin-top: 15px;
            font-size: 1em;
            font-weight: 500;
            color: var(--text);
        }
        .highlight-form {
            color: var(--primary);
            font-weight: bold;
        }
        .btn {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: none;
            background: var(--primary);
            color: white;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: background 0.2s;
        }
        .btn:hover { background: #0066CC; }
    </style>
</head>
<body>

<div class="app-container" id="app">
    <div class="header">Morphology (Sarf) Logic Engine</div>

    <div class="content">
        <div class="dial-controls-tense">
            <select id="tenseSelector" onchange="updateConjugation()" style="width:100%;">
                <option value="Past">Past Tense (الماضي)</option>
                <option value="Present">Present Tense (المضارع)</option>
            </select>
        </div>

        <div class="dial-controls">
            <select id="rootSelector" onchange="updateConjugation()">
                <!-- Options populated by JS -->
            </select>
            <select id="formSelector" onchange="updateConjugation()">
                <!-- Options populated by JS for I-X -->
            </select>
            <select id="pronounSelector" onchange="updateConjugation()">
                <!-- Options populated by JS for 14 pronouns -->
            </select>
        </div>

        <!-- FEATURE 1 & 2: CONJUGATION DISPLAY / WEAK VERB LAB -->
        <div class="verb-card">
            <div class="root-meta" id="rootDisplay"></div>
            
            <div class="result-word" id="resultWord"></div>
            <div class="form-info" id="formInfo"></div>
        </div>

        <!-- FEATURE 3: REVERSE LOOKUP -->
        <div class="reverse-input-section">
            <h3 style="margin-top:0; font-size:1.2em; border-bottom:1px solid #eee; padding-bottom:5px;">Reverse Lookup Utility</h3>
            <input type="text" id="reverseInput" placeholder="Enter word (e.g., Mutakabbir)" style="width:100%; box-sizing:border-box;">
            <button class="btn" onclick="reverseLookup()">Analyze Word Structure</button>
            <div class="reverse-results" id="reverseResult"></div>
        </div>
    </div>
</div>

<script>
    // --- STATE MANAGEMENT ---
    let state = {
        currentRoot: "D-R-S",
        currentForm: "I",
        currentPronoun: "hua",
        currentTense: "Past" // Initial Tense
    };

    // --- DATA: ROOT LOGIC ---
    const rootLogic = {
        "D-R-S": { base: "دَرَس", meaning: "To Study/Teach", type: "Strong", rootAr: "د-ر-س" }, 
        "Q-W-L": { base: "قَوَل", meaning: "To Say", type: "Hollow (Ajwaf)", rootAr: "ق-و-ل" },
        "R-M-Y": { base: "رَمَي", meaning: "To Throw", type: "Defective (Naqis)", rootAr: "ر-م-ي" }, 
        "M-D-D": { base: "مَدَد", meaning: "To Extend/Stretch", type: "Doubled (Mudha'af)", rootAr: "م-د-د" },
        "K-B-R": { base: "كَبَر", meaning: "To be Big/Great", type: "Strong", rootAr: "ك-ب-ر" }
    };
    
    // Pronoun definitions
    const pronouns = [
        { key: "hua", name: "He (هو)", type: "Strong" },
        { key: "huma_m", name: "They (2m - هما)", type: "Strong" },
        { key: "hum", name: "They (m - هم)", type: "Strong" },
        { key: "hiya", name: "She (هي)", type: "Strong" },
        { key: "huma_f", name: "They (2f - هما)", type: "Strong" },
        { key: "hunna", name: "They (f - هن)", type: "Weak" },
        { key: "anta", name: "You (m - أنت)", type: "Weak" },
        { key: "antuma_m", name: "You (2m - أنتما)", type: "Weak" },
        { key: "antum", name: "You (m.pl - أنتم)", type: "Weak" },
        { key: "anti", name: "You (f - أنتِ)", type: "Weak" },
        { key: "antuma_f", name: "You (2f - أنتما)", type: "Weak" },
        { key: "antunna", name: "You (f.pl - أنتن)", type: "Weak" },
        { key: "ana", name: "I (أنا)", type: "Weak" },
        { key: "nahnu", name: "We (نحن)", type: "Weak" }
    ];

    // Form Stems (This is the *Past* Tense base for Forms I-X)
    const formStemsPast = {
        "D-R-S": { "I": "دَرَس", "II": "دَرَّس", "III": "دَارَس", "IV": "أَدْرَس", "V": "تَدَرَّس", "VI": "تَدَارَس", "VII": "اِنْدَرَس", "VIII": "اِدْتَرَس", "IX": "اِدْرَس", "X": "اِسْتَدْرَس", },
        "Q-W-L": { "I": "قَوَل", "II": "قَوَّل", "III": "قَاوَل", "IV": "أَقْوَل", "V": "تَقَوَّل", "VI": "تَقَاوَل", "VII": "اِنْقَوَل", "VIII": "اِقْتَوَل", "IX": "اِقْوَل", "X": "اِسْتَقْوَل", },
        "R-M-Y": { "I": "رَمَي", "II": "رَمَّي", "III": "رَامَي", "IV": "أَرْمَي", "V": "تَرَمَّي", "VI": "تَرَامَي", "VII": "اِنْرَمَي", "VIII": "اِرْتَمَي", "IX": "اِرْمَي", "X": "اِسْتَرْمَي", },
        "M-D-D": { "I": "مَدَد", "II": "مَدَّد", "III": "مَادَد", "IV": "أَمْدَد", "V": "تَمَدَّد", "VI": "تَمَادَد", "VII": "اِنْمَدَد", "VIII": "اِمْتَدَد", "IX": "اِمْدَد", "X": "اِسْتَمْدَد", },
    };

    // Form Stems (This is the *Present* Tense Base/Root for Forms I-X)
    const formStemsPresent = {
        // Note: Stem is usually F-U-L for Form I, F-A-L for others
        "D-R-S": { "I": "دْرُس", "II": "دَرِّس", "III": "دَارِس", "IV": "دْرِس", "V": "دَرَّس", "VI": "دَارَس", "VII": "نْدَرِس", "VIII": "دْتَرِس", "IX": "دْرِس", "X": "سْتَدْرِس", },
        "Q-W-L": { "I": "قُول", "II": "قَوِّل", "III": "قَاوِل", "IV": "قِيل", "V": "قَوَّل", "VI": "قَاوَل", "VII": "قَال", "VIII": "قْتَل", "IX": "قَال", "X": "سْتَقِي", }, // Q-W-L weak stem
        "R-M-Y": { "I": "رْمِي", "II": "رَمِّي", "III": "رَامِي", "IV": "رْمِي", "V": "رَمَّي", "VI": "رَامَي", "VII": "رَمِي", "VIII": "رْتَمِي", "IX": "رَمِي", "X": "سْتَرْمِي", }, // R-M-Y weak stem
        "M-D-D": { "I": "مُدّ", "II": "مَدِّد", "III": "مَادِد", "IV": "مْدِد", "V": "مَدَّد", "VI": "مَادَد", "VII": "مْدَد", "VIII": "مْتَدّ", "IX": "مْدَد", "X": "سْتَمْدِد", }, // M-D-D doubled stem
    };
    
    // Past Tense Suffixes are reused
    const pastSuffixes = {
        "hua": "َ", "huma_m": "َا", "hum": "ُوا", "hiya": "َتْ", "huma_f": "َتَا", "hunna": "ْنَ", 
        "anta": "ْتَ", "antuma_m": "ْتُمَا", "antum": "ْتُمْ", "anti": "ْتِ", "antuma_f": "ْتُمَا", 
        "antunna": "ْتُنَّ", "ana": "ْتُ", "nahnu": "ْنَا" 
    };

    // Present Tense Prefixes and Suffixes
    const presentPrefixes = {
        "hua": "يَ", "huma_m": "يَ", "hum": "يَ", "hiya": "تَ", 
        "huma_f": "تَ", "hunna": "يَ", "anta": "تَ", "antuma_m": "تَ", 
        "antum": "تَ", "anti": "تَ", "antuma_f": "تَ", "antunna": "تَ", 
        "ana": "أَ", "nahnu": "نَ" 
    };
    const presentSuffixes = {
        "hua": "ُ", "huma_m": "َانِ", "hum": "ُونَ", 
        "hiya": "ُ", "huma_f": "َانِ", "hunna": "ْن", // Suffix drops final vowel
        "anta": "ُ", "antuma_m": "َانِ", "antum": "ُونَ", 
        "anti": "ِينَ", "antuma_f": "َانِ", "antunna": "ْن", // Suffix drops final vowel
        "ana": "ُ", "nahnu": "ُ" 
    };
    const presentStrongVowel = {
        "hua": "ُ", "huma_m": "", "hum": "", "hiya": "ُ", "huma_f": "", "hunna": "", 
        "anta": "ُ", "antuma_m": "", "antum": "", "anti": "", "antuma_f": "", "antunna": "", 
        "ana": "ُ", "nahnu": "ُ" 
    };

    // --- COMPLEX CONJUGATION LOGIC ---

    function conjugate(rootKey, formKey, pronounKey, tense) {
        if (tense === "Past") {
            return conjugatePast(rootKey, formKey, pronounKey);
        } else {
            return conjugatePresent(rootKey, formKey, pronounKey);
        }
    }

    function conjugatePast(rootKey, formKey, pronounKey) {
        let baseStem = formStemsPast[rootKey][formKey];
        const suffix = pastSuffixes[pronounKey];
        const pronoun = pronouns.find(p => p.key === pronounKey);
        const isWeakSuffix = pronoun.type === "Weak" || pronounKey === 'hunna';
        
        let conjugated = baseStem + suffix;
        let ruleExplanation = "";
        let visualization = "Strong"; 

        if (rootKey === "D-R-S") {
            // FIX: Removed incorrect .slice() which was cutting off the Sīn
            // Strong verb: simply combines the stem and the suffix
            if (pronounKey === "hua") {
                conjugated = baseStem + "َ";
            } else {
                // For all others, we must strip the final vowel from the base stem before adding the suffix
                conjugated = baseStem.slice(0, -1) + suffix; 
            }
            ruleExplanation = `Strong verb. The fixed stem is combined directly with the past tense suffix.`;
        } else if (rootKey === "Q-W-L") {
            if (formKey === "I") {
                if (isWeakSuffix) {
                    conjugated = "قُلْت" + suffix.slice(1);
                    ruleExplanation = `MECHANICAL FAILURE: The middle weak letter (Waw) collapses under the weight of the Sukoon-causing suffix.`;
                    visualization = "Collapse";
                } else {
                    conjugated = "قَال" + suffix;
                    ruleExplanation = `VOWEL SHIFT: The middle weak letter (Waw) converts to a long Alif.`;
                }
            } else {
                conjugated = baseStem + suffix;
                ruleExplanation = `Higher Form Rule: Hollow verbs in higher forms are generally stable in the Past Tense.`;
            }
        } else if (rootKey === "R-M-Y") {
            if (formKey === "I") {
                if (pronounKey === "hum") { 
                    conjugated = "رَمَو" + suffix;
                    ruleExplanation = `TRANSFORMATION: The final weak letter (Yā') converts to a Waw before the plural suffix.`;
                    visualization = "Collapse";
                } else if (pronounKey === "hiya" || pronounKey === "huma_f") { 
                    conjugated = "رَمَت" + suffix;
                    ruleExplanation = `DROP: The final weak letter (Yā') is dropped entirely before the feminine suffix.`;
                    visualization = "Collapse";
                } else if (isWeakSuffix) { 
                    conjugated = "رَمَيْت" + suffix.slice(1);
                    ruleExplanation = `RESTORATION: The original weak letter (Yā') is restored to its stable state before the Sukoon-causing suffix.`;
                    visualization = "Restoration";
                } else {
                    conjugated = "رَمَى" + suffix;
                    ruleExplanation = `SOUND CHANGE: The final Yā' converts to an Alif Maqsūra.`;
                }
            } else {
                conjugated = baseStem + suffix;
                ruleExplanation = `Higher Form Defective Rule: Final weak letter remains stable or is restored in this Form.`;
            }
        } else if (rootKey === "M-D-D") {
            if (formKey === "I") {
                if (isWeakSuffix || pronounKey === 'hunna') { 
                    conjugated = 'مَدَدْت' + suffix.slice(2); 
                    ruleExplanation = `UNFOLDING (IFKĀK): The two final radicals (D-D) separate to accommodate the preceding Sukoon caused by the pronoun suffix.`;
                    visualization = 'Restoration'; 
                } else { 
                    const doubledForms = {
                        'hua': 'مَدَّ', 'huma_m': 'مَدَّا', 'hum': 'مَدُّوا',
                        'hiya': 'مَدَّتْ', 'huma_f': 'مَدَّتَا'
                    };
                    conjugated = doubledForms[pronounKey] || 'مَدَّ' + suffix;
                    ruleExplanation = `DOUBLING (IDGHAM): The two final radicals assimilate into a single, emphasized letter (Shaddah).`;
                    visualization = 'Doubled'; 
                }
            } else {
                conjugated = baseStem + suffix;
                ruleExplanation = `Higher Form Doubled Rule: The final two radicals are generally stable in this form.`;
            }
        }

        return { conjugated, ruleExplanation, visualization };
    }


    function conjugatePresent(rootKey, formKey, pronounKey) {
        const prefix = presentPrefixes[pronounKey];
        const stem = formStemsPresent[rootKey][formKey];
        const suffix = presentSuffixes[pronounKey];
        const strongVowel = presentStrongVowel[pronounKey];
        
        let conjugated = prefix + stem + suffix;
        let ruleExplanation = "";
        let visualization = "Strong";
        
        // 1. STRONG ROOT (D-R-S)
        if (rootKey === "D-R-S") {
            // Strong verb: prefix + root letters + strong vowel + suffix (if applicable)
            let base = prefix + "دْرِس" + strongVowel; // Base is typically 'yad-ri-s'
            conjugated = base + suffix;
            ruleExplanation = `Strong verb. Prefix is added, the first radical takes Sukoon, and the second radical takes a fixed vowel (Kasra/Damma).`;
        } 
        
        // 2. HOLLOW ROOT (Q-W-L)
        else if (rootKey === "Q-W-L") {
            // Hollow Form I: Weak letter (Waw) is restored
            if (formKey === "I") {
                let base = prefix + "قُول"; // ya-qūl (يَقُول)
                
                if (pronounKey === 'hum' || pronounKey === 'anti' || pronounKey === 'huma_m' || pronounKey === 'huma_f' || pronounKey === 'antuma_m' || pronounKey === 'antuma_f') {
                     // Drop final vowel before long suffixes (yaqūlūna -> yaqūlūna)
                    conjugated = prefix + "قُول" + suffix; 
                    ruleExplanation = `RESTORATION: The middle weak letter (Waw) is restored in the Present Tense. The final short vowel drops before the long suffix.`;
                    visualization = "Restoration";
                } else {
                    conjugated = base + "ُ"; // yaqūlu
                    ruleExplanation = `RESTORATION: The middle weak letter (Waw) is restored in the Present Tense, forming the pattern YAFŪL.`;
                    visualization = "Restoration";
                }
            } else {
                // Simplified higher forms
                conjugated = prefix + stem + suffix;
                ruleExplanation = `Higher Form Hollow Rule: Stem structure is generally more stable in the Present Tense.`;
            }
        } 
        
        // 3. DEFECTIVE ROOT (R-M-Y)
        else if (rootKey === "R-M-Y") {
            // Defective Form I: Weak letter remains, but drops for certain pronouns
            let base = prefix + "رْمِي"; // yarmi (يَرْمِي)
            if (pronounKey === 'hum' || pronounKey === 'anti') {
                // Drop final weak letter before long suffixes (yarmīna -> yarmūna / tarmīna)
                conjugated = prefix + "رْمُ" + suffix; // yar-m-ūna (يَرْمُون)
                ruleExplanation = `DROP: The final weak letter (Yā') is dropped entirely before the long suffix (Wāw/Yā') to prevent meeting of two non-vowels.`;
                visualization = "Collapse";
            } else {
                conjugated = base; // yarmi (يَرْمِي) - ending in a long vowel
                ruleExplanation = `SOUND CHANGE: The final weak letter (Yā') is often maintained but carries no vowel (Implied case ending).`;
            }
        }
        
        // 4. DOUBLED ROOT (M-D-D)
        else if (rootKey === "M-D-D") {
            // Doubled Form I: Always Assimilated, except for 'hunna' and 'antunna'
            if (formKey === "I") {
                if (pronounKey === 'hunna' || pronounKey === 'antunna') {
                    // Unfolding for the -na suffix
                    conjugated = prefix + "مْدُد" + suffix; // yamdudna (يَمْدُدْنَ)
                    ruleExplanation = `UNFOLDING: The final radicals separate to accommodate the preceding Sukoon of the 'Nūn' suffix.`;
                    visualization = "Restoration";
                } else {
                    // Assimilated/Doubled
                    conjugated = prefix + "مُدّ" + strongVowel; // yamuddu (يَمُدُّ)
                    ruleExplanation = `DOUBLING (IDGHAM): The two final radicals assimilate into a Shaddah.`;
                }
            } else {
                conjugated = prefix + stem + suffix;
                ruleExplanation = `Higher Form Doubled Rule: Stem structure is generally stable in the Present Tense.`;
            }
        }

        return { conjugated, ruleExplanation, visualization };
    }


    // --- RENDER & DISPLAY ---

    function updateConjugation() {
        state.currentTense = document.getElementById("tenseSelector").value;
        state.currentRoot = document.getElementById("rootSelector").value;
        state.currentForm = document.getElementById("formSelector").value;
        state.currentPronoun = document.getElementById("pronounSelector").value;

        const { conjugated, ruleExplanation, visualization } = conjugate(
            state.currentRoot,
            state.currentForm,
            state.currentPronoun,
            state.currentTense
        );

        const rootDisplay = document.getElementById("rootDisplay");
        const resultWord = document.getElementById("resultWord");
        const formInfo = document.getElementById("formInfo");
        const currentRootObj = rootLogic[state.currentRoot];
        const currentPronounName = pronouns.find(p => p.key === state.currentPronoun).name;

        // --- Visual Effects ---
        resultWord.classList.remove("cracked");
        resultWord.innerHTML = "";
        rootDisplay.classList.remove("weak-letter");

        if (visualization === "Collapse") {
            // Simulate weak letter failure (Past/Present)
            const baseStem = (state.currentTense === "Past" ? formStemsPast : formStemsPresent)[state.currentRoot][state.currentForm];
            
            // Show the original base stem as cracked
            resultWord.innerHTML = `<span class="cracked" style="text-decoration: line-through;">${baseStem}</span> <span class="slide-in active">${conjugated}</span>`;
            rootDisplay.classList.add("weak-letter");
        } else if (visualization === "Restoration") {
             // Simulate weak letter restoration/unfolding
            resultWord.innerHTML = `<span style="color:var(--success);">Restoration/Unfolding</span> <span class="slide-in active">${conjugated}</span>`;
        } else {
            resultWord.innerHTML = conjugated;
        }

        // --- Info Panel Update ---
        // FIX: Ensuring D-R-S and the Arabic letters render correctly (RTL for Arabic)
        rootDisplay.innerHTML = `
            ${state.currentRoot} &middot; <span dir="rtl" style="font-size: 1.1em;">${currentRootObj.rootAr}</span>
            <div style="font-size: 0.8em; font-weight: normal; margin-top: 5px;">Type: ${currentRootObj.type}</div>
        `;
        
        let formMeaning = `Form ${state.currentForm} (${state.currentTense} Tense): ${currentPronounName} conjugated.`;

        formInfo.innerHTML = `
            <p><strong>${formMeaning}</strong></p>
            <p class="meaning-shift" style="color: ${visualization === "Collapse" ? "var(--danger)" : "var(--gray)"}">${ruleExplanation}</p>
        `;
    }
    
    // --- REVERSE LOOKUP DATA (omitted for brevity, maintained from last version) ---
    const reversePatterns = [
        { word: "كِتَابَة", root: "K-T-B", form: "I", meaning: "Writing (Verbal Noun)", stripped: "كِتَب" },
        { word: "مُدَرِّس", root: "D-R-S", form: "II", meaning: "Teacher (Active Participle)", stripped: "دَرَّس" },
        { word: "مُكَاتَبَة", root: "K-T-B", form: "III", meaning: "Correspondence (Verbal Noun)", stripped: "كَتَب" },
        { word: "إِقْدَام", root: "Q-D-M", form: "IV", meaning: "Initiative (Verbal Noun)", stripped: "قَدَم" },
        { word: "مُتَكَبِّر", root: "K-B-R", form: "V", meaning: "One who acts big (Arrogant)", stripped: "تَكَبَّر" },
        { word: "تَشَارُك", root: "SH-R-K", form: "VI", meaning: "Shared participation (Verbal Noun)", stripped: "شَرَك" },
        { word: "اِنْفِعَال", root: "F-'-L", form: "VII", meaning: "Emotion (Verbal Noun)", stripped: "فَعَل" },
        { word: "اِتِّفَاق", root: "W-F-Q", form: "VIII", meaning: "Agreement (Verbal Noun - Note Waw becomes Tā\')", stripped: "و-ف-ق" },
        { word: "اِسْتِخْدَام", root: "KH-D-M", form: "X", meaning: "Usage/Employment (Verbal Noun)", stripped: "خَدَم" },
        { word: "قَائِل", root: "Q-W-L", form: "I", meaning: "Speaker (Active Participle)", stripped: "ق-و-ل" },
        { word: "مُسْتَقِيل", root: "Q-W-L", form: "X", meaning: "One who resigns (Active Participle)", stripped: "اِسْتَقَالَ" },
        { word: "مَرْمِيّ", root: "R-M-Y", form: "I", meaning: "Thrown (Passive Participle)", stripped: "ر-م-ي" },
        { word: "اِرْتِمَاء", root: "R-M-Y", form: "VIII", meaning: "A throwing oneself (Verbal Noun)", stripped: "ر-م-ي" },
        { word: "تَوْقِيت", root: "W-Q-T", form: "II", meaning: "Timing (Verbal Noun)", stripped: "و-ق-ت" },
        { word: "إِرَادَة", root: "R-W-D", form: "IV", meaning: "Will/Desire (Verbal Noun)", stripped: "ر-و-د" },
        { word: "تَزَيُّد", root: "Z-Y-D", form: "V", meaning: "Increased/Growth (Verbal Noun)", stripped: "ز-ي-د" }
    ];

    function reverseLookup() {
        const inputElement = document.getElementById("reverseInput");
        const inputWord = inputElement.value.trim();
        const resultElement = document.getElementById("reverseResult");
        resultElement.innerHTML = "";

        if (!inputWord) {
            resultElement.innerText = "Please enter an Arabic word.";
            return;
        }

        const match = reversePatterns.find(p => p.word.toLowerCase() === inputWord.toLowerCase());

        if (match) {
            resultElement.innerHTML = `
                <p style="color:var(--success); font-weight:bold;">Analysis Complete:</p>
                <div style="background:#f9f9f9; padding:10px; border-radius:6px; font-family:monospace; font-size:0.9em;">
                    Word: ${match.word}<br>
                    Stripped Pattern: <span style="color:var(--primary);">${match.stripped || "N/A"}</span><br>
                    Reveals Root: **${match.root}** (${rootLogic[match.root]?.meaning || "Unknown"})
                </div>
                <p style="margin-top:10px;">Derived from **Form ${match.form}**.</p>
                <p class="meaning-shift">${match.meaning}</p>
            `;
        } else {
            resultElement.innerText = `Could not find pattern for "${inputWord}". Try "Mutakabbir" or "تَزَيُّد".`;
            resultElement.style.color = "var(--danger)";
        }
    }

    // Initial setup
    document.addEventListener("DOMContentLoaded", () => {
        // Map Roots
        const rootSelector = document.getElementById("rootSelector");
        Object.keys(rootLogic).forEach(key => {
            if (key !== "K-B-R") { 
                const option = document.createElement("option");
                option.value = key;
                option.textContent = `${key} (${rootLogic[key].type})`;
                rootSelector.appendChild(option);
            }
        });

        // Map Forms I-X
        const formSelector = document.getElementById("formSelector");
        formSelector.innerHTML = "";
        for (let i = 1; i <= 10; i++) {
            const formKey = i === 1 ? "I" : i === 2 ? "II" : i === 3 ? "III" : i === 4 ? "IV" : i === 5 ? "V" : i === 6 ? "VI" : i === 7 ? "VII" : i === 8 ? "VIII" : i === 9 ? "IX" : "X";
            const option = document.createElement("option");
            option.value = formKey;
            option.textContent = `Form ${formKey}`;
            formSelector.appendChild(option);
        }

        // Map 14 Pronouns
        const pronounSelector = document.getElementById("pronounSelector");
        pronounSelector.innerHTML = "";
        pronouns.forEach(p => {
            const option = document.createElement("option");
            option.value = p.key;
            option.textContent = p.name;
            pronounSelector.appendChild(option);
        });
        
        updateConjugation(); // Initial render
    });

</script>

</body>
</html>
